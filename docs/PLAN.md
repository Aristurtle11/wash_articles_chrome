# Chrome 插件重构规划

## 目标概述
- 将 `wash_articles` 中“获取网页正文与图片 → 翻译 → 排版 → 上传微信公众号”的流水线迁移为 Chrome 插件形态。
- 采用增量式迭代，每个阶段都能独立运行并可测试。
- 在不侵犯网站策略的前提下，尽量复用现有的内容提取、翻译与发布逻辑。

---

## 阶段一：基础内容提取
**范围**
- 创建最小可运行的 Chrome 插件骨架（`manifest.json`、背景脚本、内容脚本）。
- 当用户在目标站点打开页面时，内容脚本读取页面 DOM，调用移植后的 `extract_article_content` 逻辑生成正文与图片列表。
- 提供一个简单的浮动按钮，点击后在插件弹窗中展示提取结果的摘要。

**依赖迁移**
- 将 `wash_articles/src/utils/realtor_extract.py` 中的纯函数抽取为可在浏览器端运行的模块（可能需要改写为纯前端 JS/TS 实现）。
- 将必要的配置（如选择器、解析规则）从 Python 配置转写为 JSON/TS 常量。

**验收与测试**
- 手动测试：在目标网站打开页面，确认插件按钮出现且提取的文本、图片数量与 Python 版一致。
- 单元测试：使用 Jest（或 Vitest）对 DOM 解析模块进行输入/输出快照测试。

---

## 阶段二：翻译与排版
**范围**
- 在插件前端集成翻译能力：优先使用浏览器可用的云翻译 API（如 Google/DeepL Web API 或自建的 HTTP 中转服务），接口抽象保持可替换。
- 将 `Translator.render_prompt` 中的提示词逻辑转为前端可选模版，生成中文正文。
- 复用 `src/ai/formatter.py` 的排版思路，在前端实现段落重排、图片占位符同步等。
- 在插件 Popup 或新打开的标签页中渲染最终排版结果，支持复制导出。

**依赖迁移**
- 引入 Web Worker/Service Worker 处理翻译与排版，避免阻塞 UI。
- 提供可配置的 API Key 管理界面（本地 `chrome.storage` 加密保存）。

**验收与测试**
- 手动测试：对比翻译后的中文与 Python 版本输出的主要结构一致。
- 自动测试：使用组件测试（如 Playwright Component Testing）验证排版渲染正确性。

---

## 阶段三：素材管理与缓存
**范围**
- 在扩展内实现图片下载与缓存策略，利用 `chrome.downloads` 或 `chrome.storage` 保存原图/压缩图。
- 参考 `DataSaverPipeline` 的思路，提供离线存档功能（JSON/Markdown 导出）。
- 允许用户查看历史抓取记录、重新打开排版结果。

**依赖迁移**
- 将原先的文件系统写入改为浏览器存储 API。
- 设计前端状态管理（如 Zustand/Redux）确保数据在 Popup、背景页、独立页面之间同步。

**验收与测试**
- 手动测试：多次抓取后历史记录可查询、图片缓存命中。
- 自动测试：对存储层编写单元测试，模拟 `chrome.storage` 行为。

---

## 阶段四：微信公众号上传集成
**范围**
- 将 `WeChatArticleWorkflow` 的流程拆分：图片上传 → 正文替换 → 草稿提交。
- 在插件内实现与微信公众号后台的浏览器自动化：通过内容脚本模拟 UI 操作或调用其公开接口。
- 提供发布前配置页（标题、作者、封面等），并展示提交结果。

**依赖迁移**
- 由于公众号后台要求登录态，插件需要在用户已登录状态下注入脚本完成操作，避免直接存储凭据。
- 抽象发布服务层，允许切换到后端代理实现（如果未来需要服务端托管）。

**验收与测试**
- 预发布（Dry-run）模式：仅模拟上传与草稿生成流程，输出预览链接或截图。
- 集成测试：使用 Puppeteer + Chrome Extension 测试环境对公众号后台流程做端到端验证。

---

## 阶段五：用户体验与安全加固
**范围**
- UI/UX 打磨：引入设计系统，改进交互流程。
- 权限最小化审查，确保 manifest 中权限仅覆盖必要域名。
- 引入错误日志与用户反馈管道，方便排查接口/权限问题。

**验收与测试**
- 可用性测试：收集内部用户反馈，验证操作成本。
- 安全审计：手动检查敏感数据存储、权限声明；编写静态检查脚本。

---

## 长期维护建议
- 版本管理：为每个阶段建立 Git 里程碑与标签，方便回滚。
- 发布流程：配置 `web-ext` 或 CI 脚本打包与签名，支持 Chrome Web Store 上传。
- 文档与培训：同步更新 README、使用手册、故障排查指南。

