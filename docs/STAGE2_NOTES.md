# 阶段二：正文整理与排版方案

## Python 参考梳理
- `wash_articles/src/ai/formatter.py`：基于抽取结果生成 HTML，强调段落、标题与图片的排版样式。
- `wash_articles/src/spiders/...`：爬虫阶段输出的结构化条目（heading/paragraph/image）为后续整合提供原材料。
- 结论：阶段二不再依赖外部翻译服务，而是围绕「已有结构化条目 → 生成正文文本 → 渲染排版」展开。

## Chrome 插件目标拆分
1. **正文整理**
   - 在 Service Worker 中将提取到的 `items` 统一整理成 Markdown 风格的文本：标题转 `##`、段落保持原文、图片输出 `{{[Image n]}}` 占位符。
   - 便于排版模块和历史记录重用，执行完毕后写入 `translation` 字段（现表示“整理后的正文”）。
2. **排版生成**
   - 使用前端模板（`FormatterService`）渲染 HTML，保持微信公众号友好的样式配置。
   - 排版阶段从整理文本解析块结构，匹配缓存图片并填入上传后的远程链接。
3. **导出 / 交互**
   - Popup 提供 HTML 复制、导出和历史记录浏览。
   - 推荐标题基于原页面标题或正文首段自动生成，同时允许用户手动调整。

## 技术路径要点
- **内容整理逻辑**：新增 `buildArticleText` 辅助函数，避免丢失原始结构；流程仅依赖本地数据，确保无网络请求。
- **状态管理**：沿用 `ContentStore`，`translation.status` 取值为 `working/done/error`，但含义改为“正文整理阶段”；标题信息存于 `titleTask`。
- **UI 更新**：Popup 中的提示与按钮文案统一改为“正文整理”；设置页移除 Gemini API Key 配置，仅保留公众号相关选项。
- **测试**：维持 Vitest 套件，对整理 → 排版 → 上传等链路进行单元与组件测试；新增场景覆盖整理失败时的回退逻辑。

## 后续工作拆解
1. 编写正文整理函数并串联到工作流，生成默认标题与文本。
2. 调整排版与 WeChat 上传流程，使用整理结果驱动 HTML/Draft 生成。
3. 更新 Popup 文案、按钮状态与设置页；清理无用的 Gemini 依赖。
4. 补充单元测试与端到端手册，验证无网络情况下的完整流程。
