## 角色

你是一个从事 Chrome 插件开发多年的顶级一线程序员。你精通 JavaScript 开发以及软件工程的规范。你不仅擅长建立低耦合高内聚、易于维护和阅读、有后期扩展性的软件工程，更重要的是，你懂得如何将用户的需求翻译成代码语言，并且根据需求制定可行的代码构建方案。

## 你的任务

现在我是你的产品经理，我将向你描述一个 Chrome 插件的需求。请你严格按照以下顺序和要求，为我生成三个独立的文档：

1. 
2. **MVP (最小可行产品) 文档**：定义产品的核心价值、目标用户和第一版必须包含的最小功能集。
3. **软件技术设计文档 (TDD)**：基于 MVP 的范围，详细设计软件的架构、模块、数据结构和 API 接口，让程序员可以据此直接开始编码。
4. **PROGRESS.md (增量开发计划)**：将技术设计文档拆分成一个可执行的、增量式的开发任务列表 (To-do List)。每一步完成后，产品都应处于一个可测试的状态。

------



## 1. 用户需求与产品背景

### 1.1 核心问题

内容创作者（尤其是房地产经纪人）希望将国外优质网站 (如 realtor.com) 的文章快速转化为中文内容，并发布到自己的微信公众号上，但手动操作流程繁琐、耗时。

### 1.2 目标

开发一款 Chrome 插件，实现从指定网页一键抓取内容、AI 翻译润色、排版并上传至微信公众号草稿箱的全自动化流程。

### 1.3 用户的操作流程

1. 用户在浏览器中打开目标文章页面，插件图标高亮，并在右下角注入一个 "开启" 按钮。
2. 点击按钮，弹出 Popup UI。UI 核心包含 "开始处理" 和 "设置" 两个按钮。
3. **首次使用**：用户点击 "设置"，输入并保存三个关键信息：微信公众号的 appID 和 appsecret，以及 Gemini API Key。这些信息需要被安全地存储在本地。
4. **日常使用**：用户点击 "开始处理"，插件自动执行抓取、翻译、排版和上传的完整流程。
5. 处理完成后，UI 上会展示生成的标题和排版好的正文预览。用户可以对标题或正文进行 "重新生成"。
6. 所有改动都会自动同步更新到微信公众号的同一篇草稿中。
7. 用户可以配置草稿的上传选项（如作者、摘要等），配置一次后将作为默认值。

------



## 2. 工程要求与技术约束

### 2.1 架构要求

- **高扩展性**：系统的核心瓶颈在于如何适配不同网站的页面结构。内容抓取模块必须是可插拔的。未来新增一个支持的网站时，理想情况是只需增加一个对应的“解析器”文件，而无需改动核心工作流代码。**[优化说明：明确指出了扩展性的核心在于“内容抓取”部分，并暗示了“策略模式”或“适配器模式”的设计方向，这对 AI 设计解耦架构至关重要。]**
- **模块化**：严格遵循 Chrome 插件的标准架构，将职责清晰地划分到以下几个模块：content_script：负责注入 UI 到页面和从页面 DOM 中提取数据。background_script：作为事件处理中心，负责处理核心的后台任务，如调用外部 API (Gemini, 微信)、管理状态等。popup_script：负责渲染用户交互界面，并与 background_script 通信。services：存放与第三方 API 交互的逻辑，如 wechatService.js, geminiService.js。parsers：存放针对不同网站的解析器，如 realtorNewsParser.js。

### 2.2 数据结构要求

- **[优化说明：提供了清晰的数据结构，这是保证模块间稳定协作的关键。AI 可以基于此设计出更健壮的程序。]**
- 当 content_script 抓取完数据后，应将其整理成一个统一的、与网站无关的中间数据结构，例如一个包含对象的数组 ArticleContent[]：codeJSON`[  { "type": "paragraph", "content": "这是第一段文本..." },  { "type": "image", "src": "https://example.com/image1.jpg", "isCover": true },  { "type": "paragraph", "content": "这是第二段文本..." },  { "type": "image", "src": "https://example.com/image2.jpg", "isCover": false } ]`其中 isCover 字段用于标记封面图。

### 2.3 状态管理要求

- **[优化说明：将模糊的描述转化为明确的技术指令。]**
- 插件的所有工作状态（如：正在处理中、处理完成、错误等）都必须与**浏览器的 Tab ID** 绑定。
- 用户在同一个 Tab 内刷新或跳转页面，当前 Tab 的状态应被重置。
- 用户切换到其他 Tab 或打开新 Tab，插件应为新 Tab 展示一个干净的初始界面，而不影响原 Tab 的工作状态。

### 2.4 错误处理要求

- **[优化说明：要求 AI 考虑鲁棒性，这是专业软件工程的必备环节。]**
- 技术设计中必须包含关键节点的错误处理机制，至少覆盖以下场景：配置信息（API Keys, AppID 等）无效或错误。内容抓取失败（因网页结构变更）。Gemini API 调用失败（网络问题、API Key 欠费等）。微信公众号 API 调用失败（Token 过期、上传素材失败等）。UI 需要清晰地向用户展示错误信息并提供指引。

------



## 任务开始

请严格按照我为你设定的角色和上述所有需求，开始生成以下三个文档：

1. **doc/MVP.md**
2. **doc/TDD.md (Technical Design Document)**
3. **PROGRESS.md**



## 附录（另外的细节）

现在用户有一个需求，总的来说就是希望从 https://www.realtor.com/news/* 和  https://www.realtor.com/advice/* 两个网站上获取文本和图片内容，并将其重新排版并将其上传到微信公众平台。并且，后期可能会有其他网页的同样需求。

### 用户的操作流程流程

1. 用户打开浏览器，打开上述两个网站中的自网页后，插件会在其网页的右下角出现一个 button 可以开启插件的popup ui.
2. pupup ui上最上方存在但不仅存在两个button： 开始洗稿 和 配置。用户先点击配置，输入微信公众号的 appID和 appsecret，还有 gemini_api_key.
3. 用户返回popup ui中，点击开始开始洗稿，插件会收集当前网页中的文本和图片。并将文本翻译成中文，插件还会记录文中图片的位置，并将翻译后的文章和图片进行排版上传至微信公众号草稿。
4. 用户可以更改pop up ui中存在的微信公众号草稿上传选项，若用户不配置，那么就全部留空，若配置则将该配置设为默认，除非以后用户更改，则每次上传都使用该选项。

## 插件的工作流程

1. 插件只在其支持的网站开启运行的功能。
2. 插件接收到用户按下 开始洗稿 按钮后开始洗稿流程
3. 插件收集当前网站的正文文本和图片，并记录下图片应该在正文文本的什么位置。
4. 插件会将图片全部存储在一个数组中，封面图的index为0,其他的依次排列。
5. 插件会开启一个gemini 多轮对话 Session。
6. 插件将文本数组按照顺序组装拼接成一个完整的文本，送到gemini中令其翻译成中文。
7. 插件会在同一个session中再让ai基于对文本的理解生成一个标题。
8. 插件会将图片0以永久素材的形式上传微信公众号，并受到公众号返回的media_id和图片url.插件会将该图片作为后续上传微信公众号的封面。
9. 插件会将其他图片以图文消息图片的形式上传，并记录微信公众平台返回的media_id和url.
10. 插件会将翻译后的中文正文和图片(基于微信公众平台返回的url)以html的形式排版在一起。
11. 插件将排版好的正文展示在pop up ui上。
12. 插件会将排版好的正文组装进微信公众号新增草稿的json配置中
13. 插件会向微信公众平台发起添加草稿的请求。
14. 插件会接收到微信公众号返回的成功。
15. 插件翻译生成的标配和正文旁边分别有 重新生成的按钮，如果用户不满意可以点击重新生成
16. 重新生成后的内容同步更新在排版中
17. 更新后的内容通过向微信公众平台发起草稿修改的请求，同步到微信公众平台上。
18. 工作结束。

若用户在当前的网页tab中打开了另一个网页，那么插件ui及其缓存的内容不要改变，还是保持上一个网页中的任务继续进行或者保存着上一个已经完成的排版展示等内容。当用户点击停止工作时，插件才停止工作。当用户点击刷新时，插件重置当前的状态机，开始准备基于新开启的网页的工作流程。

若用户在新tab中打开了另一个网页，那么插件就展示一个尚未开始工作的干净的ui界面。

## 工程要求

1. 插件要有可扩展性，未来或许会添加对更多不同网站的内容获取需求，但是后续的翻译排版上传修改等工作流是统一的。
2. 插件或许未来会添加用户自行上传图片和自定义solgan的功能。
3. 插件未来或许会添加一个单独的微信公众号后台管理界面，用于管理微信公众平台中的草稿和图片，可能添加批量删除等其他功能